{% extends "landing/dashboard.html" %}
{% load static %}
{% block content %}
<style>
  .textnote-card {
    background: #fff;
    border: 1px solid #eaeaea;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    transition: all 0.2s ease;
  }
  
  .textnote-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.07);
    transform: translateY(-2px);
  }
  
  .textnote-card p {
    white-space: pre-wrap;  /* ← conserve les sauts de ligne */
    color: #333;
    line-height: 1.6;
    font-size: 1rem;
    margin-bottom: 0.75rem;
  }
  
  .header-section {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.04);
  }
  
  .note-title-area {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .note-title {
    font-size: 1.8rem;
    color: #2A4B7E;
    font-weight: 600;
    margin: 0;
  }
  
  .header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-top: 0.5rem;
  }
  
  .action-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .btn {
    padding: 0.625rem 1rem;
    border-radius: 30px;
    text-decoration: none;
    color: #fff;
    background: #2A4B7E;
    transition: all 0.2s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    font-weight: 500;
    font-size: 0.9rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  
  .btn i {
    margin-right: 0.5rem;
  }
  
  .btn:hover {
    background: #1E3A5A;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .btn-primary {
    background: #2A4B7E;
  }
  
  .btn-secondary {
    background: #6c757d;
  }
  
  .btn-info {
    background: #17a2b8;
  }
  
  .btn-danger {
    background: #dc3545;
  }
  
  .btn-warning {
    background: #ffc107;
    color: #212529;
  }
  
  .ai-btn {
    background: #087f5b;
  }
  
  .ai-btn:hover {
    background: #065e44;
  }
  
  .invited-label {
    color: #087f5b;
    font-style: italic;
    margin-left: 1rem;
    font-weight: 500;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    background: rgba(8, 127, 91, 0.1);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
  }
  
  .collab-info {
    margin-top: 1.5rem;
    border-top: 1px solid #eee;
    padding-top: 1.5rem;
    color: #2A4B7E;
    font-weight: 500;
  }
  
  .collab-info .user-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  
  .collab-info .user-tag {
    background: rgba(42, 75, 126, 0.1);
    color: #2A4B7E;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
  }
  
  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2A4B7E;
    margin: 2rem 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid rgba(42, 75, 126, 0.1);
  }

  .media-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }
  
  .media-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    transition: all 0.2s ease;
    position: relative;
  }
  
  .media-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  }
  
  .media-thumbnail {
    height: 140px;
    background-size: cover;
    background-position: center;
    position: relative;
  }
  
  .media-content {
    padding: 0.75rem;
  }
  
  .media-title {
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .media-info {
    font-size: 0.8rem;
    color: #6c757d;
  }
  
  .media-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 0.5rem;
  }
  
  .delete-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    z-index: 10;
    background: rgba(220, 53, 69, 0.8);
    color: white;
    border: none;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  
  .media-card:hover .delete-btn {
    opacity: 1;
  }
  
  .delete-btn:hover {
    background: #dc3545;
  }
  
  .empty-message {
    color: #6c757d;
    font-style: italic;
    margin: 1rem 0;
  }
  
  .meta-info {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 2rem;
  }
  
  /* Media query pour la responsivité */
  @media (max-width: 768px) {
    .header-section {
      flex-direction: column;
    }
    
    .header-actions {
      margin-top: 1rem;
      justify-content: flex-start;
    }
  }
</style>

<!-- MathJax pour les formules mathématiques, physiques et électriques -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)'], ['$', '$']],
      displayMath: [['\\[', '\\]'], ['$$', '$$']],
      processEscapes: true
    },
    options: {
      enableMenu: false
    }
  };
  
  // Fonction pour appliquer MathJax aux notes texte
  document.addEventListener('DOMContentLoaded', function() {
    // S'assurer que MathJax est bien chargé et appliqué à toutes les formules
    if (typeof MathJax !== 'undefined') {
      MathJax.typeset();
    }
  });
</script>

<div class="header-section">
  <div>
    <div class="note-title-area">
      <h2 class="note-title">{{ note.titre }}</h2>
      {% if invited %}
        <span class="invited-label"><i class="bi bi-person-check me-1"></i> Par invitation</span>
      {% endif %}
    </div>
    <p class="meta-info"><i class="bi bi-calendar3 me-1"></i> Créée le {{ note.date|date:"d/m/Y H:i" }}</p>
  </div>

  {% if messages %}
    <div class="messages-container mb-3 w-100">
      {% for message in messages %}
        <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div>
    <div class="action-group">
      {% if is_owner %}
        <a class="btn btn-secondary" href="{% url 'invite_collaborators' note.id %}">
          <i class="bi bi-person-plus"></i> Inviter
        </a>
      {% endif %}
      <a class="btn btn-primary" href="{% url 'create_textnote' note.id %}">
        <i class="bi bi-pencil-square"></i> Ajouter un texte
      </a>
      <a class="btn btn-info" href="{% url 'create_imagenote' note.id %}">
        <i class="bi bi-card-image"></i> Ajouter une image
      </a>
    </div>
    
    <div class="action-group">
      <a class="btn btn-danger" href="{% url 'create_pdfnote' note.id %}">
        <i class="bi bi-file-earmark-pdf-fill"></i> Ajouter un PDF
      </a>
      <a class="btn btn-primary" href="{% url 'create_audionote' note.id %}">
        <i class="bi bi-mic-fill"></i> Ajouter un audio
      </a>
      <a class="btn btn-info" href="{% url 'create_videonote' note.id %}">
        <i class="bi bi-camera-video-fill"></i> Ajouter une vidéo
      </a>
    </div>
    
    <div class="action-group">
      <a class="btn btn-success" href="{% url 'create_ocrnote' note.id %}">
        <i class="bi bi-image-alt"></i> Ajouter un OCR
      </a>
      <a class="btn ai-btn" href="{% url 'generate_resume' note.id %}">
        <i class="bi bi-magic"></i> Résumer
      </a>
      <a class="btn btn-secondary" href="{% url 'view_resumes' note.id %}">
        <i class="bi bi-file-text"></i> Résumés
      </a>
    </div>
    
    <div class="action-group">
      <a class="btn btn-warning" href="{% url 'generate_quiz' note.id %}">
        <i class="bi bi-question-circle"></i> Quiz
      </a>
      <a class="btn btn-secondary" href="{% url 'view_quizzes' note.id %}">
        <i class="bi bi-list-check"></i> Voir les quiz
      </a>
    </div>
  </div>
</div>

<h3 class="section-title"><i class="bi bi-card-text me-2"></i>Textes</h3>
{% for tn in textnotes %}
  <div class="textnote-card">
    <p>{{ tn.texte|safe }}</p>
    <div class="media-info">
      <span><i class="bi bi-person-circle me-1"></i> Édité par {{ tn.userEditeur.username }}</span> 
      <span class="ms-2"><i class="bi bi-clock me-1"></i> {{ tn.date|date:"d/m/Y H:i" }}</span>
      {% if tn.userEditeur != note.userOwner %}
        <span class="invited-label"><i class="bi bi-person-check me-1"></i> Collaborateur</span>
      {% endif %}
    </div>
  </div>
{% empty %}
  <p class="empty-message">Aucun texte ajouté pour cette note.</p>
{% endfor %}

<h3 class="section-title"><i class="bi bi-images me-2"></i>Images</h3>
<div class="media-container">
  {% for img in imagenotes %}
    <div class="media-card">
      <form
        method="POST"
        action="{% url 'delete_imagenote' img.id %}"
        onsubmit="return confirm('Voulez-vous vraiment supprimer cette image ?');"
      >
        {% csrf_token %}
        <button
          type="submit"
          class="delete-btn"
          aria-label="Supprimer"
        >&times;</button>
      </form>

      <a
        href="{% static img.path %}"
        class="glightbox"
        data-gallery="note-{{ note.id }}"
      >
        <div class="media-thumbnail" style="background-image: url('{% static img.path %}')"></div>
      </a>

      <div class="media-content">
        <div class="media-info">
          <div><i class="bi bi-person-circle me-1"></i> {{ img.userEditeur.username }}</div>
          <div><i class="bi bi-clock me-1"></i> {{ img.date|date:"d/m/Y H:i" }}</div>
        </div>
      </div>
    </div>
  {% empty %}
    <p class="empty-message">Aucune image pour cette note.</p>
  {% endfor %}
</div>

<h3 class="section-title"><i class="bi bi-file-earmark-pdf me-2"></i>PDFs</h3>
<div class="media-container">
  {% for pdf in pdfnotes %}
    <div class="media-card">
      <form method="POST"
            action="{% url 'delete_pdfnote' pdf.id %}"
            onsubmit="return confirm('Supprimer ce PDF ?');">
        {% csrf_token %}
        <button type="submit"
                class="delete-btn"
                aria-label="Supprimer PDF">
          &times;
        </button>
      </form>

      <div class="media-content text-center py-3">
        <i class="bi bi-file-earmark-pdf-fill"
           style="font-size: 2.5rem; color:#dc3545;"></i>
        <p class="media-title">
          {{ pdf.path|slice:"4:" }}
        </p>
        <div class="media-info mb-2">
          <div><i class="bi bi-person-circle me-1"></i> {{ pdf.userEditeur.username }}</div>
          <div><i class="bi bi-clock me-1"></i> {{ pdf.date|date:"d/m/Y H:i" }}</div>
        </div>
        <button class="btn btn-sm btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#pdfModal{{ pdf.id }}">
          <i class="bi bi-eye me-1"></i> Voir
        </button>
      </div>
    </div>

    <!-- Modal PDF -->
    <div class="modal fade" id="pdfModal{{ pdf.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{ pdf.path|slice:"4:" }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0">
            <iframe
              src="{% static pdf.path %}"
              width="100%"
              height="600px"
              style="border:none;"
            ></iframe>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <p class="empty-message">Aucun PDF ajouté pour cette note.</p>
  {% endfor %}
</div>

<h3 class="section-title"><i class="bi bi-mic-fill me-2"></i>Audios</h3>
<div class="media-container">
  {% for audio in audionotes %}
    <div class="media-card">
      <form method="POST"
            action="{% url 'delete_audionote' audio.id %}"
            onsubmit="return confirm('Supprimer cet audio ?');">
        {% csrf_token %}
        <button type="submit"
                class="delete-btn"
                aria-label="Supprimer audio">
          &times;
        </button>
      </form>

      <div class="media-content text-center py-3">
        <i class="bi bi-file-earmark-music"
           style="font-size: 2.5rem; color:#0d6efd;"></i>
        <p class="media-title">
          {{ audio.titre }}
        </p>
        <div class="media-info mb-2">
          <div><i class="bi bi-person-circle me-1"></i> {{ audio.userEditeur.username }}</div>
          <div><i class="bi bi-clock me-1"></i> {{ audio.date|date:"d/m/Y H:i" }}</div>
        </div>
        <audio controls class="w-100 mt-2">
          <source src="{% static audio.path %}" type="audio/mpeg">
          Votre navigateur ne supporte pas l'élément audio.
        </audio>
      </div>
    </div>
  {% empty %}
    <p class="empty-message">Aucun audio ajouté pour cette note.</p>
  {% endfor %}
</div>

<h3 class="section-title"><i class="bi bi-camera-video-fill me-2"></i>Vidéos</h3>
<div class="media-container">
  {% for video in videonotes %}
    <div class="media-card" style="width: 100%; max-width: 320px;">
      <form method="POST"
            action="{% url 'delete_videonote' video.id %}"
            onsubmit="return confirm('Supprimer cette vidéo ?');">
        {% csrf_token %}
        <button type="submit"
                class="delete-btn"
                aria-label="Supprimer vidéo">
          &times;
        </button>
      </form>

      <div class="media-content">
        <p class="media-title">
          {{ video.titre }}
        </p>
        
        <div class="media-thumbnail">
          {% if video.thumbnail %}
            <img src="{% static video.thumbnail %}" alt="{{ video.titre }}" class="img-fluid">
          {% else %}
            <div style="height: 150px; background-color: #eee; display: flex; align-items: center; justify-content: center;">
              <i class="bi bi-camera-video" style="font-size: 3rem; color: #aaa;"></i>
            </div>
          {% endif %}
        </div>
        
        <div class="media-info mb-2 mt-2">
          <div><i class="bi bi-person-circle me-1"></i> {{ video.userEditeur.username }}</div>
          <div><i class="bi bi-clock me-1"></i> {{ video.date|date:"d/m/Y H:i" }}</div>
        </div>
        
        <button class="btn btn-sm btn-primary w-100"
                data-bs-toggle="modal"
                data-bs-target="#videoModal{{ video.id }}">
          <i class="bi bi-play-fill me-1"></i> Lire la vidéo
        </button>
      </div>
    </div>

    <!-- Modal Video -->
    <div class="modal fade" id="videoModal{{ video.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{ video.titre }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0">
            <video controls width="100%" height="auto">
              <source src="{% static video.path %}" type="video/mp4">
              Votre navigateur ne supporte pas la lecture vidéo.
            </video>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <p class="empty-message">Aucune vidéo ajoutée pour cette note.</p>
  {% endfor %}
</div>

<h3 class="section-title"><i class="bi bi-image-alt me-2"></i>OCR (Reconnaissance de texte)</h3>
<div class="media-container">
  {% for ocr in ocrnotes %}
    <div class="media-card" style="width: 100%;">
      <form method="POST"
            action="{% url 'delete_ocrnote' ocr.id %}"
            onsubmit="return confirm('Supprimer cette extraction OCR ?');">
        {% csrf_token %}
        <button type="submit"
                class="delete-btn"
                aria-label="Supprimer OCR">
          &times;
        </button>
      </form>

      <div class="media-content">
        <div class="row">
          {% if ocr.image_path %}
          <div class="col-md-4">
            <div class="media-thumbnail mb-3">
              <img src="{% static ocr.image_path %}" alt="Image OCR" class="img-fluid rounded">
            </div>
          </div>
          {% endif %}
          <div class="col-md-{% if ocr.image_path %}8{% else %}12{% endif %}">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-text-paragraph me-2"></i>Texte extrait</span>
                <small class="text-muted">
                  <i class="bi bi-person-circle me-1"></i> {{ ocr.userEditeur.username }} - 
                  <i class="bi bi-clock me-1"></i> {{ ocr.date|date:"d/m/Y H:i" }}
                </small>
              </div>
              <div class="card-body">
                <p class="card-text">{{ ocr.texte_extrait }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <p class="empty-message">Aucune extraction OCR pour cette note.</p>
  {% endfor %}
</div>

{% if is_owner and collaborators %}
  <div class="collab-info">
    <i class="bi bi-people-fill me-2"></i> Collaborateurs:
    <div class="user-list">
      {% for c in collaborators %}
        <span class="user-tag"><i class="bi bi-person me-1"></i>{{ c.userCollab.username }}</span>
      {% endfor %}
    </div>
  </div>
{% endif %}

<!-- initialisation de GLightbox -->
<script src="{% static 'vendor/glightbox/js/glightbox.min.js' %}"></script>
<script>
  const lightbox = GLightbox({
    selector: '.glightbox',
    zoomable: true,
    loop: false,
    touchNavigation: true,
    keyboardNavigation: true,
  });
</script>

{% endblock %}
